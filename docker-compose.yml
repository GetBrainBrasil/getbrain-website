version: "3.9"

services:
  web:
    build: .  # Vai buildar usando o Dockerfile
    environment:
      - NODE_ENV=production
    networks:
      - network_swarm_public
    deploy:
      labels:
        - "traefik.enable=true"
        # DomÃ­nios
        - "traefik.http.routers.getbrain.rule=Host(`getbrain.com.br`, `www.getbrain.com.br`)"
        - "traefik.http.routers.getbrain.entrypoints=websecure"
        - "traefik.http.routers.getbrain.tls.certresolver=letsencryptresolver"
        # Porta do Next.js
        - "traefik.http.services.getbrain.loadbalancer.server.port=3000"
        # Redirect www -> raiz
        - "traefik.http.middlewares.www2root.redirectregex.regex=^https?://www\\.(.*)"
        - "traefik.http.middlewares.www2root.redirectregex.replacement=https://$$1"
        - "traefik.http.routers.getbrain.middlewares=www2root@docker"
        # Network para o Traefik
        - "traefik.docker.network=network_swarm_public"
      restart_policy:
        condition: on-failure

networks:
  network_swarm_public:
    external: true
